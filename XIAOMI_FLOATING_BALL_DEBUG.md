# 小米/红米 Android 15 悬浮球调试总结

## 问题分析（已解决）
在小米/红米 Android 15 设备上，原始逻辑存在以下问题：
- ❌ `InputMethodManager.isActive()` 行为异常，无法准确反映软键盘状态
- ❌ 简单的"第三方输入法 + isActive"逻辑导致悬浮球一直显示
- ❌ 用户体验不符合预期："只在输入框软键盘弹出时显示悬浮球"

## 优化方案 v2 - 多信号融合检测

### 1. 新的检测策略
- **连续性检测**：需要连续3次检测到相同状态才确认变化
- **状态稳定期**：状态变化后需要稳定3秒才最终确认  
- **多信号融合**：结合WindowInsets、InputMethodManager和输入活动
- **设备适配**：小米设备专用算法，其他设备标准检测

### 2. 核心改进
```java
// 小米设备专用检测逻辑
if (consecutiveActiveCount >= 3) {
    // 连续3次active → 键盘弹出
    newState = true;
} else if (consecutiveInactiveCount >= 3) {
    // 连续3次inactive → 键盘隐藏
    newState = false;
} else {
    // 状态不稳定，保持之前状态
    newState = lastXiaomiKeyboardState;
}

// WindowInsets信号融合
if (windowInsetsDetected && !ourLogicDetected) {
    return true; // 优先显示悬浮球
}
```

### 3. 参数调整
- **检查频率**：小米设备1.5秒/次，其他设备2秒/次
- **连续阈值**：需要连续3次相同检测结果
- **稳定时间**：状态变化需要稳定3秒才确认
- **活动超时**：输入活动超时时间从10秒减少到5秒

## 当前状态（v2）
- ✅ 多信号融合检测算法已实现
- ✅ 小米设备专用连续性检测
- ✅ WindowInsets和IMM双重确认
- ✅ 增强的调试信息和日志
- ✅ 状态稳定期防误判
- ✅ 设备检测频率优化

## 预期效果

更新后的版本应该：
1. **小米设备**：避免"一直显示悬浮球"问题，只在真正输入时显示
2. **其他设备**：保持原有稳定的检测逻辑
3. **响应性**：更快的检测频率和更准确的状态判断
4. **兼容性**：Android 15特殊适配，向下兼容

## 测试步骤

1. 重新构建并安装 APK
2. 启用悬浮球功能
3. 使用"🔧 调试悬浮球"查看增强检测状态
4. 测试场景：
   - 微信聊天：点击输入框 → 悬浮球出现 → 发送 → 自动隐藏
   - 浏览器搜索：搜索框激活 → 悬浮球出现 → 搜索完成 → 自动隐藏
   - 快速切换：连续点击不同输入框，验证响应准确性

## 关键日志

观察以下日志验证新算法：
- `Xiaomi enhanced detection` - 小米增强检测过程
- `consecutiveActive: X, consecutiveInactive: Y` - 连续状态计数
- `state confirmed change: false -> true` - 状态变化确认
- `WindowInsets override` - 多信号融合决策

## 调试信息

使用MainActivity的"🔧 调试悬浮球"功能查看：
- 连续状态计数
- 最后状态变化时间
- 多信号检测结果
- WindowInsets和IMM状态对比

## 备用方案

如果v2方案仍有问题：
1. **动态阈值**：根据设备型号调整连续检测次数
2. **用户手动控制**：添加"始终显示/隐藏悬浮球"选项
3. **应用白名单**：针对特定应用强制显示策略
4. **学习算法**：记录用户使用模式，智能预测键盘状态

---
**版本**: v2.0 - 多信号融合检测  
**更新**: 2024-12-28  
**状态**: 已实现，待测试验证
